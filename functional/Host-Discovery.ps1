Import-Module $PSScriptRoot\modules\SubNet-Calculate.psm1

$startTime = Get-Date -Format "yyyy-MM-dd HH:mm"
$timeZone = (Get-TimeZone).StandardName
Write-Output "Starting ShellMap at $startTime $timeZone"

# Concept: 
# Using the ip address list generated by SubNet-Calculate.ps1 and the input arguments:
# For each ip address from the input (1+), calculate all the subnets, once the subnets are calculated, call ping through the whole list.
# Output the successfully pinged ip addresses (hosts that are up)

# Check if input is a hostname, resolve it to a ip address before continuing:
$baseWeb = "www.google.com" # Replace with arg input from user

# ONLY get the IPv4 (for the subnet calculator!)
$resolvedIP = (Resolve-DnsName -Name $baseWeb -Type A | Select-Object -First 1).IPAddress
# Get the number of subnets wanted for the base address (arbitrary 24/1 for debugging) WILL BE REPLACED WITH INPUT
$ipAddresses = Select-IPSubnet $resolvedIP 0

# (NMap done: [#IP Addresses (256)] IP addresses, ([#Hosts up] hosts up) scanned in [total ping time] seconds)
Write-Output "ShellMap scan report for $resolvedIP"
$activeHosts = 0
$numAddresses = $ipAddresses.Count

$startTime = Get-Date
foreach($ipAddress in $ipAddresses)
{
    # ICMP echo request (PING): with -Quiet to do basic ping 
    # and only return output of those where ping is "Succeeded", true = reached target
    $pingCheck = Test-Connection $ipAddress -Quiet
    # Add to the active hosts if the ping is TRUE:
    if($pingCheck)
    {
        $activeHosts ++
    }
}
$endTime = Get-Date

$elapsedTime = ($endTime - $startTime)  
$elapsedMs = $elapsedTime.TotalMilliseconds  

Write-Output "ShellMap done: $numAddresses IP address ($activeHosts hosts up) scanned in $elapsedMs ms" 


